<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ペアリングアプリ（Firestore版）</title>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    #adminPanel { border: 1px solid #ccc; padding: 1rem; margin-top: 1rem; }
    .highlight { background: lightgreen; padding: 0.5rem; border-radius: 5px; }
    .pair { margin: 0.3rem 0; padding: 0.3rem; border-bottom: 1px solid #eee; }
  </style>
</head>
<body>
  <h1>ペアリングアプリ</h1>

  <div id="joinPanel">
    <h2>参加</h2>
    <input type="text" id="nameInput" placeholder="名前を入力"><br>
    <label><input type="radio" name="role" value="リーダー">リーダー</label>
    <label><input type="radio" name="role" value="パートナー">パートナー</label><br>
    <button id="joinBtn">参加する</button>
  </div>

  <div id="resultPanel" style="display:none;">
    <h2>結果</h2>
    <div id="myPair" class="highlight"></div>
    <h3>全体結果</h3>
    <div id="allPairs"></div>
  </div>

  <div id="adminPanel" style="display:none;">
    <h2>管理者パネル</h2>
    <label>ラウンド番号: <input type="number" id="roundNumber" min="1" max="5" value="1"></label>
    <button id="makePairsBtn">ペア生成</button>
    <button id="resetUsersBtn">全参加者リセット</button><br><br>
    <input type="text" id="deleteNameInput" placeholder="削除する名前">
    <button id="deleteUserBtn">指定ユーザ削除</button>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, setDoc, doc, deleteDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAXKK19_CHOeY8BBRh_MuOWGSXe_aVV5rE",
  authDomain: "makecouple-738b7.firebaseapp.com",
  projectId: "makecouple-738b7",
  appId: "1:592307602142:web:423c226103d6114f36b84f",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// 管理者の固定UID (テスト用、実際は別管理が望ましい)
const ADMIN_UID = "admin123"; 
let currentUser = null;
let myName = "";

// 匿名ログイン
signInAnonymously(auth).then(userCred => {
  currentUser = userCred.user;
  console.log("ログイン成功:", currentUser.uid);
  if (currentUser.uid === ADMIN_UID) {
    document.getElementById("adminPanel").style.display = "block";
  }
});

// 参加処理
document.getElementById("joinBtn").onclick = async () => {
  myName = document.getElementById("nameInput").value.trim();
  const role = document.querySelector("input[name='role']:checked")?.value;
  if (!myName || !role) { alert("名前と役割を入力してください"); return; }

  await addDoc(collection(db, "participants"), { name: myName, role: role });
  document.getElementById("joinPanel").style.display = "none";
  document.getElementById("resultPanel").style.display = "block";
};

// ペア生成（管理者のみ）
document.getElementById("makePairsBtn").onclick = async () => {
  const snap = await getDocs(collection(db, "participants"));
  const participants = snap.docs.map(doc => doc.data());

  // 過去ペアを収集
  const roundsSnap = await getDocs(query(collection(db, "rounds"), orderBy("createdAt")));
  const pastPairs = new Set();
  roundsSnap.forEach(doc => {
    doc.data().pairs.forEach(pairObj => {
      const pair = pairObj.members;
      pastPairs.add(pair.sort().join("_"));
    });
  });

  let leaders = participants.filter(p => p.role === "リーダー");
  let partners = participants.filter(p => p.role === "パートナー");
  leaders = leaders.sort(() => Math.random() - 0.5);
  partners = partners.sort(() => Math.random() - 0.5);

  let pairs = [];

  while (leaders.length > 0 && partners.length > 0) {
    const leader = leaders.pop();
    const partner = partners.pop();
    const key = [leader.name, partner.name].sort().join("_");

    if (!pastPairs.has(key)) {
      pairs.push([leader.name, partner.name]);
    } else {
      // 重複時は仕方なくそのまま
      pairs.push([leader.name, partner.name]);
    }
  }

  // 余り -> 最初のペアに追加して3人組
  if (leaders.length > 0) pairs[0].push(leaders.pop().name);
  else if (partners.length > 0) pairs[0].push(partners.pop().name);

  const roundNumber = document.getElementById("roundNumber").value;
  await setDoc(doc(db, "rounds", "round" + roundNumber), {
    round: roundNumber,
    pairs: pairs.map(p => ({ members: p })), // ← ネスト配列禁止対策
    createdAt: new Date()
  });
};

// 全ユーザ削除（管理者）
document.getElementById("resetUsersBtn").onclick = async () => {
  const snap = await getDocs(collection(db, "participants"));
  snap.forEach(async d => { await deleteDoc(doc(db, "participants", d.id)); });
  alert("参加者リセットしました");
};

// 指定ユーザ削除（管理者）
document.getElementById("deleteUserBtn").onclick = async () => {
  const nameToDelete = document.getElementById("deleteNameInput").value.trim();
  if (!nameToDelete) return;
  const snap = await getDocs(collection(db, "participants"));
  snap.forEach(async d => {
    if (d.data().name === nameToDelete) {
      await deleteDoc(doc(db, "participants", d.id));
      alert(`${nameToDelete} を削除しました`);
    }
  });
};

// 結果表示リスナー
const roundNumberInput = document.getElementById("roundNumber");
roundNumberInput.addEventListener("change", () => listenRound(roundNumberInput.value));

function listenRound(roundNumber) {
  onSnapshot(doc(db, "rounds", "round" + roundNumber), (docSnap) => {
    if (docSnap.exists()) {
      const data = docSnap.data();
      const allPairsDiv = document.getElementById("allPairs");
      allPairsDiv.innerHTML = "";
      let myPairText = "";
      data.pairs.forEach(pairObj => {
        const pair = pairObj.members;
        const div = document.createElement("div");
        div.className = "pair";
        div.textContent = pair.join(" - ");
        if (pair.includes(myName)) {
          div.style.background = "lightblue";
          myPairText = "あなたの組み合わせ: " + pair.join(" - ");
        }
        allPairsDiv.appendChild(div);
      });
      document.getElementById("myPair").textContent = myPairText;
    }
  });
}

// 初期ラウンド監視
listenRound(roundNumberInput.value);

</script>
</body>
</html>
