<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ペアリングアプリ</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .highlight { background: #c8f7c5; padding: 5px; border-radius: 5px; }
    .pair { margin: 5px 0; padding: 5px; border: 1px solid #ddd; border-radius: 5px; }
    button { padding: 10px 20px; margin: 5px; }
  </style>
</head>
<body>
  <h2>ペアリングアプリ</h2>

  <div id="setup">
    <label>名前: <input type="text" id="name"></label><br/>
    <label>
      役割:
      <select id="role">
        <option value="leader">リーダー</option>
        <option value="partner">パートナー</option>
      </select>
    </label><br/>
    <button id="joinBtn">参加</button>
  </div>

  <div id="controls" style="display:none;">
    <button onclick="makePairs(1)">Round 1 のペア作成</button>
    <button onclick="makePairs(2)">Round 2 のペア作成</button>
  </div>

  <h3>結果</h3>
  <div id="results"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, setDoc, doc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAXKK19_CHOeY8BBRh_MuOWGSXe_aVV5rE",
      authDomain: "makecouple-738b7.firebaseapp.com",
      projectId: "makecouple-738b7",
      appId: "1:592307602142:web:423c226103d6114f36b84f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let myName = "";
    let myRole = "";

    document.getElementById("joinBtn").onclick = async () => {
      myName = document.getElementById("name").value.trim();
      myRole = document.getElementById("role").value;

      if (!myName) {
        alert("名前を入力してください");
        return;
      }

      await addDoc(collection(db, "participants"), {
        name: myName,
        role: myRole
      });

      document.getElementById("setup").style.display = "none";
      document.getElementById("controls").style.display = "block";
    };

    // ペア作成ロジック
    async function makePairs(round) {
      // 既存の参加者を取得
      const snap = await getDocs(collection(db, "participants"));
      const leaders = [];
      const partners = [];
      snap.forEach(doc => {
        const d = doc.data();
        if (d.role === "leader") leaders.push(d.name);
        else partners.push(d.name);
      });

      let pairs = [];
      let minLen = Math.min(leaders.length, partners.length);

      // 通常ペア
      for (let i = 0; i < minLen; i++) {
        pairs.push([leaders[i], partners[i]]);
      }

      // 余り処理
      let leftover = [];
      if (leaders.length > partners.length) {
        leftover = leaders.slice(minLen);
      } else if (partners.length > leaders.length) {
        leftover = partners.slice(minLen);
      }

      if (leftover.length > 0 && pairs.length > 0) {
        // 余りを最初のペアに追加 → 3人組
        pairs[0].push(leftover[0]);
      }

      await setDoc(doc(db, "rounds", `round${round}`), { pairs });
    }

    // リアルタイムでペア表示
    onSnapshot(collection(db, "rounds"), (snapshot) => {
      let resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "";
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const roundTitle = document.createElement("h4");
        roundTitle.textContent = docSnap.id;
        resultsDiv.appendChild(roundTitle);

        data.pairs.forEach(pair => {
          const div = document.createElement("div");
          div.className = "pair";
          div.textContent = pair.join(" + ");
          if (pair.includes(myName)) {
            div.classList.add("highlight");
          }
          resultsDiv.appendChild(div);
        });
      });
    });
  </script>
</body>
</html>
